<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flashcards viewer</title>
    <link rel="stylesheet" href="static/style.css">
    <script src="static/cdn.min.js" defer></script>
    <script src="static/i18n.min.js"></script>
    <script src="static/jszip.min.js"></script>
    <script src="static/sql-wasm.js"></script>
    <script src="static/tablesort.min.js"></script>
    <script src="static/script.js"></script>
</head>
<!-- If a file was given by hash, load it -->
<body
x-data="{ files: {}, selectedFile: null, selectedDeck: null, selectedNote: null, selectedTemplate: null, flipped: false }"
x-init="setupTranslations(); addFilesTo([location.hash.substring(1)], files)">
    <div class="dropzone"
    x-data="{ draggingCount: 0 }"
    :class="draggingCount && 'dragging'"
    @dragover.prevent.stop="draggingCount = $event.dataTransfer.items.length || 1"
    @dragleave.prevent.stop="draggingCount = 0"
    @drop.prevent.stop="draggingCount = 0; addFilesTo($event.dataTransfer, files)">
        <span x-show="draggingCount" x-text="draggingCount > 1 ? $t('Release the files!') : $t('Release the file!')"></span>
    </div>
    <h1 x-data x-text="$t('Flashcards viewer')"></h1>
    <span x-data x-text="$t('Select file to open:')"></span>
    <input type="file" x-init="$el.value = ''" @change="$el.files.length && openFile($el.files[0]).then(f => files[f[0]] = f[1])">
    <br>
    <!-- Be careful to dots in the translations! (= object traversing e.g. data.media) -->
    <!-- https://github.com/rehhouari/alpinejs-i18n/blob/f761b7b/src/index.ts#L74 -->
    <span x-data x-text="$t('Or drag some files into this window') + '.'"></span>
    <ul class="files">
        <template x-data x-for="file, fileName in files">
            <li x-text="fileName" @click="selectedFile = file"></li>
        </template>
    </ul>
    <template x-if="selectedFile">
        <ul class="decks">
            <template x-data x-for="deck, deckId in selectedFile.decks">
                <!-- https://stackoverflow.com/a/4009768 -->
                <li
                x-show="!isHidden(deckId, selectedFile.decks)"
                :style="{ '--depth': deck.name.match(/::/g)?.length || 0 }">
                    <span
                    x-text="deck.hasChildren ? (deck.collapsed ? '+' : '-') : ''"
                    @click="deck.collapsed = !deck.collapsed"></span>
                    <span x-text="deck.name" @click="selectedDeck = getDeck(selectedFile, deckId)"></span>
                </li>
            </template>
        </ul>
    </template>
    <template x-if="selectedDeck">
        <table class="notes sort">
            <thead>
                <tr>
                    <template x-data x-for="field in FIELDS">
                        <th x-text="$t(field)"></th>
                    </template>
                </tr>
            </thead>
            <tbody>
                <template x-data x-for="note in selectedDeck">
                    <tr @click="selectedNote = note">
                        <template x-data x-for="field, fieldName in FIELDS">
                            <td x-text="getField(note, fieldName, selectedFile)"></td>
                        </template>
                    </tr>
                </template>
            </tbody>
        </table>
    </template>
    <template x-if="selectedNote">
        <ul class="templates">
            <template x-data x-for="template in selectedFile.models[selectedNote.mid].tmpls.map((e, i) => [e, i])">
                <li x-text="template[0].name" @click="selectedTemplate = template[1]"></li>
            </template>
        </ul>
    </template>
    <template x-if="selectedTemplate !== null">
        <div>
            <div class="card" x-html="await renderWithMedia(selectedFile.models[selectedNote.mid], selectedTemplate, selectedNote, selectedFile, flipped)"></div>
            <button @click="flipped = !flipped" x-text="$t('Flip')"></button>
        </div>
    </template>
</body>
</html>
